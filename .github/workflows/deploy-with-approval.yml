# GitHub Actions Workflow with Agent 365 Approval Gate
# This workflow demonstrates Agents pipeline with human-in-the-loop approval
# Reference: https://learn.microsoft.com/en-us/entra/agent-id/identity-platform/what-is-agent-registry

name: Deploy to AKS with Agent Approval

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'k8s/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - development
          - staging
          - production
      skip_approval:
        description: 'Skip approval (dev only)'
        required: false
        default: false
        type: boolean

env:
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  AKS_CLUSTER_NAME: ${{ secrets.AKS_CLUSTER_NAME }}
  ACR_NAME: ${{ secrets.ACR_NAME }}
  IMAGE_NAME: mcp-agents
  K8S_NAMESPACE: mcp-agents

jobs:
  # ============================================================================
  # Build and Push Container Image
  # ============================================================================
  build:
    name: Build and Push
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
      image_digest: ${{ steps.push.outputs.digest }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_NAME }}.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=semver,pattern={{version}}

      - name: Build and Push
        id: push
        uses: docker/build-push-action@v5
        with:
          context: ./src
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # ============================================================================
  # Agent 365 Approval Gate
  # This job requests human approval via Microsoft Teams
  # ============================================================================
  request-approval:
    name: Request Deployment Approval
    runs-on: ubuntu-latest
    needs: build
    if: github.event.inputs.skip_approval != 'true' || github.event.inputs.environment == 'production'
    outputs:
      approval_id: ${{ steps.request.outputs.approval_id }}
      approved: ${{ steps.wait.outputs.approved }}
      approver: ${{ steps.wait.outputs.approver }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install aiohttp azure-identity azure-cosmos

      - name: Request Approval via Agent 365
        id: request
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          COSMOSDB_ENDPOINT: ${{ secrets.COSMOSDB_ENDPOINT }}
          LOGIC_APP_APPROVAL_WEBHOOK: ${{ secrets.LOGIC_APP_APPROVAL_WEBHOOK }}
        run: |
          python << 'EOF'
          import asyncio
          import os
          import sys
          sys.path.insert(0, 'src')
          
          from agent365_approval import (
              ApprovalWorkflowEngine,
              ApprovalContract,
              Agent365AvailabilityChecker,
          )
          
          async def request_approval():
              # Check Agent 365 availability
              checker = Agent365AvailabilityChecker()
              availability = await checker.check_availability()
              print(f"Agent 365 available: {availability.available}")
              
              # Initialize workflow engine
              engine = ApprovalWorkflowEngine(
                  cosmos_endpoint=os.getenv("COSMOSDB_ENDPOINT"),
                  logic_app_webhook_url=os.getenv("LOGIC_APP_APPROVAL_WEBHOOK"),
              )
              
              # Create approval request
              contract = await engine.initiate_approval(
                  task="Set up a CI/CD pipeline for deploying microservices to Kubernetes",
                  requested_by=os.getenv("GITHUB_ACTOR", "github-actions"),
                  environment="${{ github.event.inputs.environment || 'staging' }}",
                  cluster="${{ env.AKS_CLUSTER_NAME }}",
                  namespace="${{ env.K8S_NAMESPACE }}",
                  image_tags=["${{ needs.build.outputs.image_tag }}"],
                  commit_sha="${{ github.sha }}",
                  pipeline_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                  rollback_url="${{ github.server_url }}/${{ github.repository }}/actions/workflows/rollback.yml",
              )
              
              print(f"Approval requested: {contract.approval_id}")
              
              # Output for GitHub Actions
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write(f"approval_id={contract.approval_id}\n")
              
              return contract
          
          asyncio.run(request_approval())
          EOF

      - name: Wait for Approval
        id: wait
        timeout-minutes: 120  # 2 hour timeout
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          COSMOSDB_ENDPOINT: ${{ secrets.COSMOSDB_ENDPOINT }}
        run: |
          python << 'EOF'
          import asyncio
          import os
          import sys
          sys.path.insert(0, 'src')
          
          from agent365_approval import (
              ApprovalWorkflowEngine,
              ApprovalDecision,
              AgentValidationStatus,
          )
          
          async def wait_for_approval():
              engine = ApprovalWorkflowEngine(
                  cosmos_endpoint=os.getenv("COSMOSDB_ENDPOINT"),
              )
              
              approval_id = "${{ steps.request.outputs.approval_id }}"
              print(f"Waiting for approval: {approval_id}")
              print("Check Microsoft Teams for the approval request...")
              
              try:
                  contract = await engine.wait_for_approval(
                      approval_id=approval_id,
                      timeout_seconds=7200,  # 2 hours
                  )
                  
                  approved = contract.decision == ApprovalDecision.APPROVED.value
                  validated = contract.agent_validation == AgentValidationStatus.PASSED.value
                  
                  with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                      f.write(f"approved={'true' if approved and validated else 'false'}\n")
                      f.write(f"approver={contract.approved_by or 'unknown'}\n")
                  
                  if not approved:
                      print(f"❌ Deployment rejected by {contract.approved_by}")
                      print(f"Reason: {contract.comment or 'No reason provided'}")
                      exit(1)
                  
                  if not validated:
                      print(f"❌ Agent validation failed")
                      exit(1)
                  
                  print(f"✅ Deployment approved by {contract.approved_by}")
                  
              except TimeoutError:
                  print("❌ Approval timed out after 2 hours")
                  exit(1)
          
          asyncio.run(wait_for_approval())
          EOF

  # ============================================================================
  # Deploy to AKS (requires approval)
  # ============================================================================
  deploy:
    name: Deploy to AKS
    runs-on: ubuntu-latest
    needs: [build, request-approval]
    if: needs.request-approval.outputs.approved == 'true'
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
      url: https://${{ env.AKS_CLUSTER_NAME }}.region.cloudapp.azure.com
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS Credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }}

      - name: Deploy to AKS
        run: |
          # Update image in deployment manifest
          IMAGE="${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ needs.build.outputs.image_tag }}"
          
          # Apply Kubernetes manifests
          kubectl set image deployment/mcp-agents \
            mcp-agents=$IMAGE \
            -n ${{ env.K8S_NAMESPACE }}
          
          kubectl rollout status deployment/mcp-agents \
            -n ${{ env.K8S_NAMESPACE }} \
            --timeout=300s

      - name: Record Deployment Completion
        env:
          COSMOSDB_ENDPOINT: ${{ secrets.COSMOSDB_ENDPOINT }}
        run: |
          echo "Recording deployment completion for approval: ${{ needs.request-approval.outputs.approval_id }}"
          echo "Approved by: ${{ needs.request-approval.outputs.approver }}"
          echo "Deployed image: ${{ needs.build.outputs.image_tag }}"

  # ============================================================================
  # Notify on Rejection
  # ============================================================================
  notify-rejection:
    name: Notify Rejection
    runs-on: ubuntu-latest
    needs: [request-approval]
    if: failure() || needs.request-approval.outputs.approved != 'true'
    
    steps:
      - name: Send Rejection Notification
        run: |
          echo "Deployment was rejected or timed out"
          echo "Approval ID: ${{ needs.request-approval.outputs.approval_id }}"
          # Add Teams/Slack notification here
